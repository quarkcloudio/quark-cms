!function(t){"use strict";function e(t){return a({validate:!1,root_name:"#document"}).parse(t,{format:"xhtml"})}function n(t){return t.replace(/<\/?[A-Z]+/g,(function(t){return t.toLowerCase()}))}var i=function(t){function e(){return n}var n=t;return{get:e,set:function(t){n=t},clone:function(){return i(e())}}},l=tinymce.util.Tools.resolve("tinymce.PluginManager"),o=function(){return(o=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var l in e=arguments[n])Object.prototype.hasOwnProperty.call(e,l)&&(t[l]=e[l]);return t}).apply(this,arguments)},r=tinymce.util.Tools.resolve("tinymce.util.Tools"),a=tinymce.util.Tools.resolve("tinymce.html.DomParser"),c=tinymce.util.Tools.resolve("tinymce.html.Node"),s=tinymce.util.Tools.resolve("tinymce.html.Serializer"),u=function(t){return t.getParam("fullpage_hide_in_source_view")},d=function(t){return t.getParam("fullpage_default_xml_pi")},f=function(t){return t.getParam("fullpage_default_encoding")},m=function(t){return t.getParam("fullpage_default_font_family")},g=function(t){return t.getParam("fullpage_default_font_size")},p=function(t){return t.getParam("fullpage_default_text_color")},y=function(t){return t.getParam("fullpage_default_title")},h=function(t){return t.getParam("fullpage_default_doctype","<!DOCTYPE html>")},v=e,_=function(t,n){var i,l,o=e(n),a={};function c(t,e){return t.attr(e)||""}return a.fontface=m(t),a.fontsize=g(t),7===(i=o.firstChild).type&&(a.xml_pi=!0,(l=/encoding="([^"]+)"/.exec(i.value))&&(a.docencoding=l[1])),(i=o.getAll("#doctype")[0])&&(a.doctype="<!DOCTYPE"+i.value+">"),(i=o.getAll("title")[0])&&i.firstChild&&(a.title=i.firstChild.value),r.each(o.getAll("meta"),(function(t){var e,n=t.attr("name"),i=t.attr("http-equiv");n?a[n.toLowerCase()]=t.attr("content"):"Content-Type"===i&&(e=/charset\s*=\s*(.*)\s*/gi.exec(t.attr("content")))&&(a.docencoding=e[1])})),(i=o.getAll("html")[0])&&(a.langcode=c(i,"lang")||c(i,"xml:lang")),a.stylesheets=[],r.each(o.getAll("link"),(function(t){"stylesheet"===t.attr("rel")&&a.stylesheets.push(t.attr("href"))})),(i=o.getAll("body")[0])&&(a.langdir=c(i,"dir"),a.style=c(i,"style"),a.visited_color=c(i,"vlink"),a.link_color=c(i,"link"),a.active_color=c(i,"alink")),a},b=function(t,n,i){var l,o,a,u,d,f=t.dom;function m(t,e,n){t.attr(e,n||void 0)}function g(t){o.firstChild?o.insert(t,o.firstChild):o.append(t)}l=e(i),(o=l.getAll("head")[0])||(u=l.getAll("html")[0],o=new c("head",1),u.firstChild?u.insert(o,u.firstChild,!0):u.append(o)),u=l.firstChild,n.xml_pi?(d='version="1.0"',n.docencoding&&(d+=' encoding="'+n.docencoding+'"'),7!==u.type&&(u=new c("xml",7),l.insert(u,l.firstChild,!0)),u.value=d):u&&7===u.type&&u.remove(),u=l.getAll("#doctype")[0],n.doctype?(u||(u=new c("#doctype",10),n.xml_pi?l.insert(u,l.firstChild):g(u)),u.value=n.doctype.substring(9,n.doctype.length-1)):u&&u.remove(),u=null,r.each(l.getAll("meta"),(function(t){"Content-Type"===t.attr("http-equiv")&&(u=t)})),n.docencoding?(u||((u=new c("meta",1)).attr("http-equiv","Content-Type"),u.shortEnded=!0,g(u)),u.attr("content","text/html; charset="+n.docencoding)):u&&u.remove(),u=l.getAll("title")[0],n.title?(u?u.empty():g(u=new c("title",1)),u.append(new c("#text",3)).value=n.title):u&&u.remove(),r.each("keywords,description,author,copyright,robots".split(","),(function(t){var e,i,o=l.getAll("meta"),r=n[t];for(e=0;e<o.length;e++)if((i=o[e]).attr("name")===t)return void(r?i.attr("content",r):i.remove());r&&((u=new c("meta",1)).attr("name",t),u.attr("content",r),u.shortEnded=!0,g(u))}));var p={};return r.each(l.getAll("link"),(function(t){"stylesheet"===t.attr("rel")&&(p[t.attr("href")]=t)})),r.each(n.stylesheets,(function(t){p[t]||((u=new c("link",1)).attr({rel:"stylesheet",text:"text/css",href:t}),u.shortEnded=!0,g(u)),delete p[t]})),r.each(p,(function(t){t.remove()})),(u=l.getAll("body")[0])&&(m(u,"dir",n.langdir),m(u,"style",n.style),m(u,"vlink",n.visited_color),m(u,"link",n.link_color),m(u,"alink",n.active_color),f.setAttribs(t.getBody(),{style:n.style,dir:n.dir,vLink:n.visited_color,link:n.link_color,aLink:n.active_color})),(u=l.getAll("html")[0])&&(m(u,"lang",n.langcode),m(u,"xml:lang",n.langcode)),o.firstChild||o.remove(),(a=s({validate:!1,indent:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(l)).substring(0,a.indexOf("</body>"))},x=function(t,e){var n=_(t,e.get()),i=o(o({},{title:"",keywords:"",description:"",robots:"",author:"",docencoding:""}),n);t.windowManager.open({title:"Metadata and Document Properties",size:"normal",body:{type:"panel",items:[{name:"title",type:"input",label:"Title"},{name:"keywords",type:"input",label:"Keywords"},{name:"description",type:"input",label:"Description"},{name:"robots",type:"input",label:"Robots"},{name:"author",type:"input",label:"Author"},{name:"docencoding",type:"input",label:"Encoding"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:i,onSubmit:function(i){var l=i.getData(),o=b(t,r.extend(n,l),e.get());e.set(o),i.close()}})},k=function(t,e){t.addCommand("mceFullPageProperties",(function(){x(t,e)}))},C=function(t,e){return r.each(t,(function(t){e=e.replace(t,(function(t){return"\x3c!--mce:protected "+escape(t)+"--\x3e"}))})),e},A=function(t){return t.replace(/<!--mce:protected ([\s\S]*?)-->/g,(function(t,e){return unescape(e)}))},w=r.each,P=function(t){var e,n="",i="";if(d(t)){var l=f(t);n+='<?xml version="1.0" encoding="'+(l||"ISO-8859-1")+'" ?>\n'}return n+=h(t),n+="\n<html>\n<head>\n",(e=y(t))&&(n+="<title>"+e+"</title>\n"),(e=f(t))&&(n+='<meta http-equiv="Content-Type" content="text/html; charset='+e+'" />\n'),(e=m(t))&&(i+="font-family: "+e+";"),(e=g(t))&&(i+="font-size: "+e+";"),(e=p(t))&&(i+="color: "+e+";"),n+"</head>\n<body"+(i?' style="'+i+'"':"")+">\n"},T=function(e,i,l){e.on("BeforeSetContent",(function(o){!function(e,i,l,o){var a,c,s,d,f="",m=e.dom;if(!(o.selection||(s=C(e.settings.protect,o.content),"raw"===o.format&&i.get()||o.source_view&&u(e)))){0!==s.length||o.source_view||(s=r.trim(i.get())+"\n"+r.trim(s)+"\n"+r.trim(l.get())),-1!==(a=(s=s.replace(/<(\/?)BODY/gi,"<$1body")).indexOf("<body"))?(a=s.indexOf(">",a),i.set(n(s.substring(0,a+1))),-1===(c=s.indexOf("</body",a))&&(c=s.length),o.content=r.trim(s.substring(a+1,c)),l.set(n(s.substring(c)))):(i.set(P(e)),l.set("\n</body>\n</html>")),d=v(i.get()),w(d.getAll("style"),(function(t){t.firstChild&&(f+=t.firstChild.value)}));var g=d.getAll("body")[0];g&&m.setAttribs(e.getBody(),{style:g.attr("style")||"",dir:g.attr("dir")||"",vLink:g.attr("vlink")||"",link:g.attr("link")||"",aLink:g.attr("alink")||""}),m.remove("fullpage_styles");var p=e.getDoc().getElementsByTagName("head")[0];f&&m.add(p,"style",{id:"fullpage_styles"}).appendChild(t.document.createTextNode(f));var y={};r.each(p.getElementsByTagName("link"),(function(t){"stylesheet"===t.rel&&t.getAttribute("data-mce-fullpage")&&(y[t.href]=t)})),r.each(d.getAll("link"),(function(t){var e=t.attr("href");if(!e)return!0;y[e]||"stylesheet"!==t.attr("rel")||m.add(p,"link",{rel:"stylesheet",text:"text/css",href:e,"data-mce-fullpage":"1"}),delete y[e]})),r.each(y,(function(t){t.parentNode.removeChild(t)}))}}(e,i,l,o)})),e.on("GetContent",(function(t){!function(t,e,n,i){i.selection||i.source_view&&u(t)||(i.content=A(r.trim(e)+"\n"+r.trim(i.content)+"\n"+r.trim(n)))}(e,i.get(),l.get(),t)}))},O=function(t){t.ui.registry.addButton("fullpage",{tooltip:"Metadata and document properties",icon:"document-properties",onAction:function(){t.execCommand("mceFullPageProperties")}}),t.ui.registry.addMenuItem("fullpage",{text:"Metadata and document properties",icon:"document-properties",onAction:function(){t.execCommand("mceFullPageProperties")}})};!function(){l.add("fullpage",(function(t){var e=i(""),n=i("");k(t,e),O(t),T(t,e,n)}))}()}(window);